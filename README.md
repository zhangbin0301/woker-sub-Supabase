# 节点聚合订阅管理系统 - 网页部署教程

本教程将指导您如何仅通过 Cloudflare 的网页仪表板（Dashboard）来部署基于 Worker 和 Supabase 的节点聚合订阅管理系统。此方法无需使用命令行工具（如 Wrangler），适合希望快速、便捷部署的用户。

### 先决条件

* 一个 [Cloudflare 账户](https://dash.cloudflare.com/sign-up)。
* 一个 [Supabase 账户](https://supabase.com/dashboard)。

### 第一步：设置 Supabase 项目

**重要提示**: 这一步与之前的教程完全相同，是部署前必须完成的准备工作。如果您已经完成了 Supabase 的配置，请直接跳到 **第二步**。

1.  **创建新项目**:
    * 访问您的 [Supabase 仪表板](https://supabase.com/dashboard) 并创建一个新项目。
    * 在项目的 **Settings** > **API** 中，找到并复制您的 **项目 URL** (`Project URL`) 和 **anon 公钥** (`anon key`)。稍后会用到。
    * 举例：
    * Project URL:https://nqjyvaxbhkjguy*****.supabase.co  
    * anonpublic:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xanl2YXhiaGtqZ3V5bmJyZ3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDMxNzcsImV4cCI6MjA3NDcxOTE3N30.tE4pPw2w2iMes2oYwj7fFqehXd1zG8GAZlU*****

2.  **创建数据库表**:
    * 在您的 Supabase 项目中，进入 **SQL Editor** 页面。
    * 运行以下 SQL 命令来创建所需的数据库表：

    ```sql
    -- 创建 urls 表，用于存储自动上传的节点
    CREATE TABLE urls (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        url_name text UNIQUE,
        url text,
        last_update bigint,
        expiration_ttl integer
    );

    -- 创建 sub2_urls 表，用于存储自定义的节点或订阅链接
    CREATE TABLE sub2_urls (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        url text UNIQUE
    );

    -- 创建 exclude_keywords 表，用于存储需要过滤的关键词
    CREATE TABLE exclude_keywords (
        id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        keyword text UNIQUE
    );
    ```

3.  **创建 RPC 函数**:
    * 继续在 SQL Editor 中，执行以下 SQL 命令以创建所需的数据库函数：

    ```sql
    -- 删除 urls 表中的所有数据
    CREATE OR REPLACE FUNCTION delete_all_urls() RETURNS void AS $$BEGIN DELETE FROM urls; END;$$ LANGUAGE plpgsql;

    -- 删除 sub2_urls 表中的所有数据
    CREATE OR REPLACE FUNCTION delete_all_sub2_urls() RETURNS void AS $$BEGIN DELETE FROM sub2_urls; END;$$ LANGUAGE plpgsql;

    -- 删除 exclude_keywords 表中的所有数据
    CREATE OR REPLACE FUNCTION delete_all_keywords() RETURNS void AS $$BEGIN DELETE FROM exclude_keywords; END;$$ LANGUAGE plpgsql;

    -- 删除过期的节点
    CREATE OR REPLACE FUNCTION delete_expired_urls(expired_time bigint) RETURNS void AS $$BEGIN DELETE FROM urls WHERE last_update < expired_time; END;$$ LANGUAGE plpgsql;

    -- 初始化函数
    CREATE OR REPLACE FUNCTION init_tables() RETURNS void AS $$BEGIN END;$$ LANGUAGE plpgsql;
    ```

### 第二步：通过 Cloudflare 网页创建和配置 Worker

1.  **登录 Cloudflare 仪表板**:
    * 打开并登录您的 [Cloudflare 账户](https://dash.cloudflare.com)。

2.  **导航至 Workers**:
    * 在左侧的菜单栏中，选择 **Workers & Pages**。

3.  **创建服务 (Create Application)**:
    * 在 **Overview** 页面，点击 **Create Application** 按钮。
    * 选择 **Create Worker** 选项卡。
    * 为您的 Worker 服务设置一个唯一的名称（例如 `my-sub-worker`）。这个名称将成为您 Worker URL 的一部分。
    * 点击 **Deploy**。

4.  **编辑 Worker 代码**:
    * 服务创建成功后，点击 **Configure Service** 或 **Edit code** 按钮进入 Worker 的配置和编辑界面。
    * Cloudflare 会为您生成一个默认的 "Hello World" 脚本。**删除编辑器中的所有默认代码**。
    * 将 `sub-worker-Supabase.js` 文件的**全部内容**复制并粘贴到代码编辑器中。

5.  **自定义配置 (可选)**:
    * 在代码编辑器中，您可以直接修改顶部的 `CONFIG` 对象来定制您的路径和密钥，例如 `UUID`, `TOKEN`, `UP`, `DO` 等。

6.  **配置环境变量 (Secrets)**:
    * 这是最关键的一步。在 Worker 的配置页面中，找到 **Settings** 选项卡。
    * 在 `Settings` 页面下，选择 **Variables** 子菜单。
    * 在 **Environment Variables** > **Secrets** 部分，点击 **Add variable** 来添加以下三个必需的变量：
        * **Variable name**: `PSWD`
        * **Value**: 输入您想要设置的管理后台**登录密码**。
        * 点击 **Encrypt** 保存。

        * **Variable name**: `SUPABASE_URL`
        * **Value**: 粘贴您在第一步中复制的 Supabase **项目 URL**。 我的是https://nqjyvaxbhkjguynbrgya.supabase.co
        * 点击 **Encrypt** 保存。

        * **Variable name**: `SUPABASE_ANON_KEY`
        * **Value**: 粘贴您在第一步中复制的 Supabase **anon 公钥**。 我的是eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xanl2YXhiaGtqZ3V5bmJyZ3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDMxNzcsImV4cCI6MjA3NDcxOTE3N30.tE4pPw2w2iMes2oYwj7fFqehXd1zG8GAZlUIQpYF45s
        * 点击 **Encrypt** 保存。

7.  **部署最终版本**:
    * 完成代码粘贴和环境变量设置后，返回到代码编辑界面 (点击 **Quick edit** 或 **Edit code**)。
    * 点击右上角的 **Save and Deploy** 按钮。
    * Cloudflare 会将您的代码和配置部署到全球网络。等待部署完成的提示。

### 第三步：访问和使用

* **访问管理后台**:
    部署成功后，您的 Worker 会有一个 `.workers.dev` 的地址。您可以在 Worker 的主页面上找到它。
    管理后台的地址为：
    `https://<您的-Worker-名称>.<您的-Cloudflare-子域名>.workers.dev/sub-<您配置的UUID>`

* **登录**:
    打开上述地址，输入您在 `PSWD` 环境变量中设置的密码即可登录和使用。

至此，您已成功通过网页界面完成了所有部署步骤。
